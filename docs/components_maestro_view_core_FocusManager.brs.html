<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>components/maestro/view/core/FocusManager.brs - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <li class="nav-link nav-home-link"><a href="index.html">Home</a></li><li class="nav-heading">Modules</li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-BaseObservable.html">BaseObservable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-BaseObservable.html#BaseObservable">BaseObservable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-BaseObservable.html#bindField">bindField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-BaseObservable.html#notifyBinding">notifyBinding</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-BaseObservable.html#observeField">observeField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-BaseObservable.html#setContext">setContext</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-BaseObservable.html#setField">setField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-BaseObservable.html#unbindField">unbindField</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-BaseScreen.html">BaseScreen</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-BaseScreen.html#_getTopScreen">_getTopScreen</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-BaseScreen.html#getTopScreen">getTopScreen</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-BaseView.html">BaseView</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-BaseView.html#intializeView">intializeView</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-BaseViewModel.html">BaseViewModel</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-BaseViewModel.html#new">new</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-BaseViewModel.html#push">push</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-FocusManager.html">FocusManager</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-FocusMixin.html">FocusMixin</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-FocusMixin.html#focusMixinInit">focusMixinInit</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-FocusMixin.html#initializeFocusManager">initializeFocusManager</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-FocusMixin.html#onGainedFocus">onGainedFocus</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-FocusMixin.html#onGainedFocus">onGainedFocus</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-FocusMixin.html#setFocus">setFocus</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-FocusMixin.html#setFocusLocked">setFocusLocked</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-FocusMixin.html#unsetFocus">unsetFocus</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-KeyMixin.html">KeyMixin</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-MaestroUtils.html">MaestroUtils</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-MaestroUtils.html#getcontentField">getcontentField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-MaestroUtils.html#getContentFieldPlus">getContentFieldPlus</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-MTU%2520MaestroThreadUtils.html">MTU MaestroThreadUtils</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-ObservableMixin.html">ObservableMixin</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ObservableMixin.html#.bindFieldTwoWay">bindFieldTwoWay</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ObservableMixin.html#.bindingCallback">bindingCallback</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ObservableMixin.html#.bindNodeField">bindNodeField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ObservableMixin.html#.bindObservableField">bindObservableField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ObservableMixin.html#.checkValidInputs">checkValidInputs</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ObservableMixin.html#.cleanup">cleanup</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ObservableMixin.html#.createBindingProperties">createBindingProperties</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ObservableMixin.html#.observeField">observeField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ObservableMixin.html#.observerCallback">observerCallback</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ObservableMixin.html#.registerObservable">registerObservable</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ObservableMixin.html#.unbindFieldTwoWay">unbindFieldTwoWay</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ObservableMixin.html#.unbindNodeField">unbindNodeField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ObservableMixin.html#.unbindObservableField">unbindObservableField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ObservableMixin.html#.unobserveField">unobserveField</a></span></li><li class="nav-item"><span class="nav-item-type type-function">F</span><span class="nav-item-name"><a href="module-ObservableMixin.html#.unregisterObservable">unregisterObservable</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-TabController.html">TabController</a></span></li><li class="nav-heading"><span class="nav-item-type type-module">M</span><span class="nav-item-name"><a href="module-ViewModelMixin.html">ViewModelMixin</a></span></li>
</nav>

<div id="main">
    
    <h1 class="page-title">components/maestro/view/core/FocusManager.brs</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'import "pkg:/source/rLog/rLogMixin.bs"
'import "pkg:/source/maestro/lib/Utils.bs"

' /**
'  * @module FocusManager
'  * @description Source of truth about application focus
'  */

function init() as void
  registerLogger("FocusManager")
  m.top.observeField("_debugM", "onDebugMChange")
  
  m.wasShown = false
  m.isKeyPressLocked = false
end function

function onDebugMChange()
  logInfo("dumping m for debugging purposes")
  m.top._m = m
end function


'+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
'++ public api
'+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

function setFocusOn(node, isForced = false) as void
  if m.top.isLocked
    if isForced
      logWarn("overriding setting locked focus (locked reason:", m.top.lockReason, ")")
    else
      logWarn("cannot set focus, it is locked - reason :", m.top.lockReason)
      return 
    end if
  end if
  
  if isValid(node)
    parents = getParents(node)
    
    if isInScene(parents)
      
      if m.top.isLogging
        logInfo("setting focus to ", node.subType(), ".", node.id)
      end if
      
      _setFocusOn(node, parents)
    else
      logError("set focus to an off scene node! - in future this will set the focus to a backup-context node, to stop illegal focus scenarios")
    end if
  end if
  
end function

function unsetFocusOn(node)
  logInfo("manualy unsetting focus on node")
  node.setFocus(false)
end function

function setFocusLocked(isLocked, reason = "")
  logWarn("setFocusLocked is currently disabled pending further testing")
  return invalid
  
  if isLocked
    logInfo("locking focus due to reason", reason)
  else
    logInfo("unlocking focus - previous lock reason:", m.top.lockReason)
  end if
  
  m.top.lockReason = reason
  m.top.isLocked = isLocked
end function

'+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
'++ private impl
'+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

function _setFocusOn(node, parents) as void
  currentNode = m.top.focusedNode
  
  if currentNode &lt;> invalid
    
    if currentNode.doesExist("isFocused")
      currentNode.isFocused = false
    end if
    
    setFieldOnNodes(m.parents, "isChildFocused", false)
  end if
  
  m.top.focusedNode = node
  m.parents = parents
  
  if node &lt;> invalid
    
    node.setFocus(true)
    
    if node.doesExist("isFocused")
      node.isFocused = true
    end if
    
    setFieldOnNodes(parents, "isChildFocused", true)
  else
    logError("set focus to invalid node! - in future this will set the focus to a backup-context node, to stop illegal focus scenarios")
  end if
end function

function getParents(node)
  parent = node.getParent()
  parents = []
  
  while (parent &lt;> invalid)
    
    if parent.subType() = "ModelLocator"
      logWarn("trying to focus on a view that is not yet on the view hierarchy")
      return []
    end if

    parents.push(parent)
    parent = parent.getParent()
  end while
  
  return parents
end function

function isValid(node)
  
  if  mu_isUndefined(node)
    logError("asked to focus on undefined node")
    return false
  else if node = invalid
    logError("asked to focus on invalid node")
    return false
  else if type(node) &lt;> "roSGNode"
    logError("asked to focus on non rsgnode")
    return false
  end if
  
  return true
end function 

function isInScene(parents)
  
  if parents.count() = 0
    logError("asked to focus on node with no parents")
    return false
  end if
  
  lastParent = parents[parents.count() - 1]
  
  if not lastParent.isSubType("Scene")
    logError("node is not in the scene")
    return false
  end if
  
  return true
end function

function setFieldOnNodes(nodes, field, value)
  
  for i = 0 to nodes.count() - 2 'don't notify the scene
    node = nodes[i]
    
    if node.doesExist(field)
      node[field] = value
    end if
    
  end for
  
end function
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon May 04 2020 19:09:15 GMT-0500 (-05) using the Minami theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
